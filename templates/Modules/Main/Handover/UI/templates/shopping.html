<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equipment Categories</title>
    <style>
        /* Basic styling for the buttons */
        .category-button {
            padding: 10px 20px;
            background-color: #21aba9;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        .left-pane {
    width: 400px;
    height: 100%;
    background-color: #f0f0f0;
    padding: 10px;
    box-sizing: border-box;
    position: absolute; /* or position: fixed; */
    right: 0;
    top: 0;
}
table {
    border-collapse: collapse;
    font-size: 10px !important;
  }
  th, td {
    border: 1px solid black;
    padding: 8px;
    text-align: left;
    font-size: 10px !important;
  }
  th {
    font-size: 10px !important;
    background-color: lightgray;
  }


.medium-button {
    width: 350px;
    height: 20px;
    font-size: 12px;
padding-bottom: 20px;
margin-bottom: -1px;
}




</style>
</head>
<body>
<h2>Handover Form</h2>

<form id="handoverForm">

  <label>From Person :</label>
  <label id="FromPerson">Loading From Person Name ....</label>
  <br><br>

  <label for="FromProject">From Project:</label>
  <select id="FromProject" name="FromProject" required>
    <option value="">Select Project</option>
    <option value="SOI Tripura">SOI Tripura</option>
    <option value="SOI ASSAM">SOI ASSAM</option>
    <option value="SOI HP">SOI HP</option>
  </select><br><br>


    <label for="ToPerson">To Person:</label>
    <select id="ToPerson" name="ToPerson" required>
      <option value="">Select Person</option>
      <option value="Fahad">Fahad</option>
      <option value="Umar">Umar</option>
      <option value="Zafar">Zafar</option>
    </select><br><br>

    <label for="ToProject">To Project:</label>
    <select id="ToProject" name="ToProject" required>
      <option value="">Select Project</option>
      <option value="SOI Tripura">SOI Tripura</option>
      <option value="SOI ASSAM">SOI ASSAM</option>
      <option value="SOI HP">SOI HP</option>
    </select><br><br>

<div class="left-pane">

    <div class="uav">
        <h4>UAV</h4>
    </div>

    <div class="dgps_eq">
        <h4>DGPS Equipment</h4>
    </div>

    <div class="extras">
        <h4>Extras</h4>
    </div>

</div>

<div class="table">
    <table id="mainTable">
        <th>Serial</th>  
        <th>Category</th>   
        <th>Product ID</th>
        <th>Name</th>
        <th>Make</th>
        <th>Model</th> 
        <th>Condition</th>
        <th>Remark</th>
        <th>Delete Row</th>
</div>

</form>

<input type="button" value="Transfer Items" id="submitButton">
<h4 id="statusMessage" style="margin-bottom: -15px; margin-top: 10px;">Press this button to initiate the item transfer process</h4>

<br>
<br>

</body>
<script>


    var tableBody = document.querySelector("#mainTable tbody");



    function logRowValues() {
    var formObject = []; // Initialize formObject as an array

    // Object to store values from other form elements
    var otherFormValues = {
    FromProject: document.getElementById("FromProject").value,
    ToProject: document.getElementById("ToProject").value,
    FromPerson: document.getElementById("FromPerson").textContent.trim(),
    ToPerson: document.getElementById("ToPerson").value,
    };
    console.log(otherFormValues)
    formObject.push(otherFormValues); // Append otherFormValues to formObject array



    // Loop through table rows and collect data
    var rows = tableBody.querySelectorAll('tr');
    rows.forEach(function(row, index) {
        if (index !== 0) { // Skip the header row
            var cells = row.querySelectorAll('td');
            var rowData = {
                Category: cells[1].innerText,
                ProductID: cells[2].innerText,
                Name: cells[3].innerText,
                Make: cells[4].innerText,
                Model: cells[5].innerText,
                SenderCondition: cells[6].querySelector('select').value,
                SenderRemarks: cells[7].querySelector('input[type="text"]').value
            };
            formObject.push(rowData); // Append rowData to formObject array
        }
    });
    console.log(formObject); // Check the collected data in formObject

    var xhr = new XMLHttpRequest();
xhr.open("POST", "send_approval_request", true);

xhr.onreadystatechange = function() {
    if (xhr.readyState === XMLHttpRequest.DONE) {
        if (xhr.status === 200) {
            var data = JSON.parse(xhr.responseText);
            // Check if the response indicates success
            if (data.message === 'Excel file updated successfully') {
                // Update the h4 tag with the success message
                document.getElementById("statusMessage").textContent = "Handover process has been successfully initiated, the email is sent to your manager successfully";
                document.getElementById("statusMessage").style.color = "green";
            } else {
                console.error('Error:', data.message);
            }
        } else {
            console.error('Error:', xhr.status);
        }
    }
};

xhr.setRequestHeader("Content-Type", "application/json");
xhr.send(JSON.stringify(formObject));
}

window.onload = function() {
    // Create a new XMLHttpRequest object
    var xhr = new XMLHttpRequest();

    // Define the request URL
    var url = '/cart_items';

    // Set up the request
    xhr.open('GET', url, true);

    // Define the onload event handler
    xhr.onload = function() {
        if (xhr.status >= 200 && xhr.status < 300) {
            // Parse the response data as JSON
            var responseData = JSON.parse(xhr.responseText);
            console.log("This is the response data", responseData)
            // Check if responseData has a 'data' property containing the array
            if (responseData.hasOwnProperty('data') && Array.isArray(responseData.data)) {
                // Call generateButtons with the array data
                generateButtons(responseData.data);

                // Update Handover Person Name label
                document.getElementById("FromPerson").textContent = responseData.data[0]['FromPerson'];

            } else {
                console.error('Invalid data format received from server:', responseData);
            }
        } else {
            console.error('Request failed with status:', xhr.status);
        }
    };

    // Define the onerror event handler
    xhr.onerror = function() {
        console.error('Request failed:', xhr.statusText);
    };

    // Send the request
    xhr.send();

    // Add event listeners to select elements to check for default option
    var selectElements = document.querySelectorAll('select[required]');
    selectElements.forEach(function(selectElement) {
        selectElement.addEventListener('change', function() {
            if (selectElement.value !== "") {
                // Enable the submit button when all required fields are selected
                submitButton.disabled = false;
            } else {
                // Disable the submit button if any required field is not selected
                submitButton.disabled = true;
            }
        });
    });
};

document.getElementById("submitButton").addEventListener("click", function(event) {
    var selectElements = document.querySelectorAll('select[required]');
    var errorMessage = "";

    // Check if any required select element is empty
    selectElements.forEach(function(selectElement) {
        if (selectElement.value === "") {
            errorMessage = "Please select a value for all required fields.";
        }
    });

    // If there is any error, prevent form submission and show the error message
    if (errorMessage !== "") {
        event.preventDefault(); // Prevent form submission
        alert(errorMessage); // Show the error message
    } else {
        // Check if From Person and To Person, and From Project and To Project are the same
        var fromPerson = document.getElementById("FromPerson").textContent.trim();
        var toPerson = document.getElementById("ToPerson").value;
        var fromProject = document.getElementById("FromProject").value;
        var toProject = document.getElementById("ToProject").value;
        
        if (fromPerson === toPerson && fromProject === toProject) {
            errorMessage = "From Person and To Person, and From Project and To Project should not be the same.";
        }

        // If there is any error, prevent form submission and show the error message
        if (errorMessage !== "") {
            event.preventDefault(); // Prevent form submission
            alert(errorMessage); // Show the error message
        } else {
            // If there are no rows in the table
            if (tableBody.rows.length <= 1) {
                errorMessage = "Please select at least one item to send.";
            }

            // If there is any error, prevent form submission and show the error message
            if (errorMessage !== "") {
                event.preventDefault(); // Prevent form submission
                alert(errorMessage); // Show the error message
            } else {
                // If all validations pass, change the message and disable the button
                document.getElementById("statusMessage").textContent = "The transfer initiation has begun, please wait for success message";
                document.getElementById("submitButton").disabled = true;
                logRowValues();
            }
        }
    }
});




// Define a set to store product IDs of items currently in the table
var productIDsInTable = new Set();

function generateButtons(data) {
    // Check if data is an array
    if (!Array.isArray(data)) {
        console.error('Data is not an array:', data);
        return;
    }

    data.forEach(item => {
        // Concatenate the values with hyphens
        var buttonText = `${item['Name']} - ${item['Make']} - ${item['Model']} - ${item['ProductID']}`;
        
        // Create a new button element
        var button = document.createElement('button');
        button.className = 'category-button';
        button.innerText = buttonText; // Set the button text to the concatenated string
        
        // Check if the product ID is already present in the table
        if (productIDsInTable.has(item['ProductID'])) {
            button.disabled = true; // Disable the button if the product ID is already present
        } else {
            // Add click event listener to each button
            button.addEventListener('click', function() {
                populateTable(item);
                index = index + 1;
                // Add the product ID to the set
                productIDsInTable.add(item['ProductID']);
                // Enable the button after adding the item to the table
                button.disabled = true;
            });
        }

        // Determine the category and append the button to the corresponding div
        switch (item.Category) {
            case 'UAV':
                var electronicsDiv = document.querySelector('.uav');
                if (electronicsDiv) {
                    button.classList.add('medium-button'); // Apply button size class
                    electronicsDiv.appendChild(button);
                    electronicsDiv.appendChild(document.createElement('br')); // Add line break
                }
                break;
            case 'DGPS Equipment':
                var dgpsEqDiv = document.querySelector('.dgps_eq');
                if (dgpsEqDiv) {
                    button.classList.add('medium-button'); // Apply button size class
                    dgpsEqDiv.appendChild(button);
                    dgpsEqDiv.appendChild(document.createElement('br')); // Add line break
                }
                break;
            case 'Extras':
                var droneEqDiv = document.querySelector('.extras');
                if (droneEqDiv) {
                    button.classList.add('medium-button'); // Apply button size class
                    droneEqDiv.appendChild(button);
                    droneEqDiv.appendChild(document.createElement('br')); // Add line break
                }
                break;
            default:
                break;
        }
    });
}


var index = 0;
function populateTable(item) {
    var table = document.getElementById('mainTable');
    var newRow = table.insertRow(-1); // Insert new row at the end of the table

    // Insert cells with item data
    var serialNoCell = newRow.insertCell(0);
    var category = newRow.insertCell(1);
    var ProductIDCell = newRow.insertCell(2);
    var productNameCell = newRow.insertCell(3);
    var makeCell = newRow.insertCell(4);
    var modelCell = newRow.insertCell(5);
    var conditionCell = newRow.insertCell(6);
    var remarkCell = newRow.insertCell(7);
    var deleteCell = newRow.insertCell(8); // New cell for delete button

    // Set cell values
    serialNoCell.innerText = index + 1; // Serial number starts from 1
    category.innerText = item['Category'];
    ProductIDCell.innerText = item['ProductID'];
    productNameCell.innerText = item['Name']; // Adjusted to match the provided JSON structure
    makeCell.innerText = item['Make'];
    modelCell.innerText = item['Model'];

    // Create select dropdown for condition
    var conditionSelect = document.createElement('select');
    conditionSelect.className = 'Condition';
    conditionSelect.name = 'Condition';
    var options = ['Good', 'Not Ok', 'Damaged'];
    options.forEach(option => {
        var optionElement = document.createElement('option');
        optionElement.value = option;
        optionElement.innerText = option;
        conditionSelect.appendChild(optionElement);
    });
    conditionCell.appendChild(conditionSelect);

    // Create input field for remarks
    var remarksInput = document.createElement('input');
    remarksInput.type = 'text';
    remarksInput.className = 'remarks';
    remarksInput.name = 'remarks';
    remarksInput.size = '40';
    remarkCell.appendChild(remarksInput);

    // Create delete button
    var deleteButton = document.createElement('button');
    deleteButton.innerText = 'Delete';
    deleteButton.className = 'delete-button';
    deleteButton.addEventListener('click', function() {
        // Remove the product ID from the set
        productIDsInTable.delete(item['ProductID']);
        table.deleteRow(newRow.rowIndex); // Delete the row when delete button is clicked
        // Re-enable the button corresponding to the deleted item
        var buttons = document.querySelectorAll('.category-button');
        buttons.forEach(function(button) {
            if (button.innerText === `${item['Name']} - ${item['Make']} - ${item['Model']} - ${item['ProductID']}`) {
                button.disabled = false;
            }
        });
    });
    deleteCell.appendChild(deleteButton);

    // Add the product ID to the set
    productIDsInTable.add(item['ProductID']);
}


</script>
</body>
</html>
